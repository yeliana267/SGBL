@using Microsoft.AspNetCore.Mvc.ViewFeatures
@model SGBL.Application.ViewModels.NotificationIndexViewModel
@{
    ViewData["Title"] = "Notificaciones";
}

<h2 class="mt-3">Notificaciones</h2>

@if (TempData["ok"] != null)
{
    <div class="alert alert-success">@TempData["ok"]</div>
}
@if (TempData["error"] != null)
{
    <div class="alert alert-danger">@TempData["error"]</div>
}
@if (TempData["info"] != null)
{
    <div class="alert alert-info">@TempData["info"]</div>
}

<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col">
                <form asp-action="Index" method="get" class="row g-3 align-items-end">
                    <div class="col-auto">
                        <label class="form-label" for="userId">Id de usuario</label>
                        <input class="form-control" id="userId" name="userId" type="number" value="@(Model.UserId ?? 0)" min="0" />
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">Filtrar</button>
                    </div>
                </form>
            </div>
            @if (Model.UserId.HasValue && Model.UserId.Value > 0)
            {
                <div class="col-auto">
                    <form asp-action="MarkAllAsRead" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="userId" value="@Model.UserId" />
                        <button type="submit" class="btn btn-success" @(Model.UnreadCount == 0 ? "disabled" : string.Empty)>
                            Marcar todas como leídas (@Model.UnreadCount)
                        </button>
                    </form>
                </div>
            }
        </div>
    </div>
</div>

@{
    var unreadViewData = new ViewDataDictionary(ViewData)
    {
        ["ShowActions"] = true,
        ["UserId"] = Model.UserId
    };

    var allViewData = new ViewDataDictionary(ViewData)
    {
        ["ShowActions"] = true,
        ["UserId"] = Model.UserId
    };
}

@if (Model.UnreadNotifications.Any())
{
    <div class="mb-4">
        <h4>No leídas (@Model.UnreadCount)</h4>
        @await Html.PartialAsync("_NotificationTable", Model.UnreadNotifications, unreadViewData)
    </div>
}

<div>
    <h4>Todas (@Model.Notifications.Count)</h4>
    @await Html.PartialAsync("_NotificationTable", Model.Notifications, allViewData)
</div>