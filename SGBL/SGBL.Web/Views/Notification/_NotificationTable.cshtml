@using System.Linq
@model IEnumerable<SGBL.Application.ViewModels.NotificationViewModel>
@{
    var showActions = ViewData["ShowActions"] as bool? ?? false;
    var userId = ViewData["UserId"] as int?;
}

<table class="table table-striped table-bordered">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Mensaje</th>
            <th>Creada</th>
            <th>Leída</th>
            <th>Estado</th>
            <th>Tipo</th>
            <th>Libro</th>
            <th>Préstamo</th>
            @if (showActions)
            {
                <th>Acciones</th>
            }
        </tr>
    </thead>
    <tbody>
        @if (!Model.Any())
        {
            <tr>
                <td colspan="@(showActions ? 10 : 9)" class="text-center">No hay notificaciones para mostrar.</td>
            </tr>
        }
        else
        {
            foreach (var notification in Model)
            {
                <tr class="@(notification.IsRead ? string.Empty : "table-warning")">
                    <td>@notification.Id</td>
                    <td>@notification.Title</td>
                    <td>@notification.Message</td>
                    <td>@notification.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        @if (notification.ReadDate.HasValue)
                        {
                            @notification.ReadDate.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Pendiente</span>
                        }
                    </td>
                    <td>@notification.StatusDescription</td>
                    <td>@notification.Type</td>
                    <td>@(notification.IdBook.HasValue ? notification.IdBook.Value.ToString() : "-")</td>
                    <td>@(notification.IdLoan.HasValue ? notification.IdLoan.Value.ToString() : "-")</td>
                    @if (showActions)
                    {
                        <td>
                            <a asp-action="Details" asp-route-id="@notification.Id" class="btn btn-sm btn-info me-2">Ver</a>
                            @if (!notification.IsRead)
                            {
                                <form asp-action="MarkAsRead" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@notification.Id" />
                                    @if (userId.HasValue)
                                    {
                                        <input type="hidden" name="userId" value="@userId" />
                                    }
                                    <button type="submit" class="btn btn-sm btn-success">Marcar como leída</button>
                                </form>
                            }
                        </td>
                    }
                </tr>
            }
        }
    </tbody>
</table>