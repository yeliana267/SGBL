@using SGBL.Application.ViewModels
@model SGBL.Application.ViewModels.AuthorViewModel
@{
    ViewData["Title"] = "Gestión de Autores";
    var action = ViewData["Action"] as string ?? "index";
    var authorList = ViewData["AuthorList"] as List<AuthorViewModel> ?? new List<AuthorViewModel>();
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">@ViewData["Title"]</h1>
        <a href="@Url.Action("Index", new { viewAction = "create" })" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nuevo Autor
        </a>
    </div>

    <!-- Listado de Autores -->
    @if (action == "index")
    {
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Lista de Autores</h5>
            </div>
            <div class="card-body">
                @if (authorList.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Biografía</th>
                                    <th>Fecha Nacimiento</th>
                                    <th>Nacionalidad</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var author in authorList)
                                {
                                    <tr>
                                        <td>@author.Id</td>
                                        <td>@author.Name</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(author.Biography))
                                            {
                                                @(author.Biography.Length > 50 ? author.Biography.Substring(0, 50) + "..." : author.Biography)
                                            }
                                        </td>
                                        <td>@author.BirthDate.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            @(author.Nationalities?.FirstOrDefault(n => n.Id == author.Nationality)?.Name ?? "N/A")
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="@Url.Action("Index", new { viewAction = "details", id = author.Id })" 
                                                   class="btn btn-info" title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="@Url.Action("Index", new { viewAction = "edit", id = author.Id })" 
                                                   class="btn btn-warning" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="@Url.Action("Index", new { viewAction = "delete", id = author.Id })" 
                                                   class="btn btn-danger" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No hay autores registrados.
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <!-- Formulario para Create/Edit/Delete/Details -->
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            @(action == "create" ? "Crear Autor" :
                              action == "edit" ? "Editar Autor" :
                              action == "delete" ? "Eliminar Autor" : "Detalles del Autor")
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (action != "delete" && action != "details")
                        {
                           <form method="post" action="@Url.Action("Index")">
                                @Html.AntiForgeryToken()
                                
                                <!-- ⭐ CAMPO HIDDEN PARA viewAction -->
                                <input type="hidden" name="viewAction" value="@action" />
                                
                                <input type="hidden" asp-for="Id" />

                                <div class="form-group mb-3">
                                    <label asp-for="Name" class="form-label">Nombre *</label>
                                    <input asp-for="Name" class="form-control" 
                                           readonly="@(action == "details")" />
                                    <span asp-validation-for="Name" class="text-danger"></span>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="Biography" class="form-label">Biografía</label>
                                    <textarea asp-for="Biography" class="form-control" rows="4"
                                              readonly="@(action == "details")"></textarea>
                                    <span asp-validation-for="Biography" class="text-danger"></span>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="BirthDate" class="form-label">Fecha de Nacimiento *</label>
                                    <input asp-for="BirthDate" type="date" class="form-control"
                                           readonly="@(action == "details")" />
                                    <span asp-validation-for="BirthDate" class="text-danger"></span>
                                </div>

                                <div class="form-group mb-3">
                                    <label asp-for="Nationality" class="form-label">Nacionalidad *</label>
                                    <select asp-for="Nationality" class="form-control" 
                                            asp-items="@(new SelectList(Model.Nationalities ?? new List<NationalityViewModel>(), "Id", "Name"))"
                                            disabled="@(action == "details")">
                                        <option value="">Seleccione una nacionalidad</option>
                                    </select>
                                    <span asp-validation-for="Nationality" class="text-danger"></span>
                                </div>

                                @if (action != "details")
                                {
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn @(action == "create" ? "btn-primary" : "btn-warning")">
                                            @(action == "create" ? "Crear" : "Actualizar")
                                        </button>
                                        <a href="@Url.Action("Index")" class="btn btn-secondary">Cancelar</a>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex gap-2">
                                        <a href="@Url.Action("Index", new { viewAction = "edit", id = Model.Id })" 
                                           class="btn btn-warning">Editar</a>
                                        <a href="@Url.Action("Index")" class="btn btn-secondary">Volver</a>
                                    </div>
                                }
                            </form>
                        }
                        else if (action == "delete")
                        {
                            <!-- Vista de Confirmación de Eliminación -->
                            <div class="alert alert-warning">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>¿Está seguro que desea eliminar este autor?</h6>
                                <p class="mb-1"><strong>Nombre:</strong> @Model.Name</p>
                                <p class="mb-0">Esta acción no se puede deshacer.</p>
                            </div>

                            <form method="post" asp-action="Index" asp-route-viewAction="delete">
                                @Html.AntiForgeryToken()
                                
                                <!-- ⭐ CAMPO HIDDEN PARA viewAction -->
                                <input type="hidden" name="viewAction" value="delete" />
                                
                                <input type="hidden" asp-for="Id" />
                                
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-trash me-1"></i>Eliminar
                                    </button>
                                    <a href="@Url.Action("Index")" class="btn btn-secondary">Cancelar</a>
                                </div>
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        // Mensajes de TempData
        $(document).ready(function() {
            if ('@TempData["success"]') {
                toastr.success('@TempData["success"]');
            }
            if ('@TempData["error"]') {
                toastr.error('@TempData["error"]');
            }
        });
    </script>
}